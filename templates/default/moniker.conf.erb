[DEFAULT]
<% "TODO: Cleanup all the duplication..." -%>
########################
## General Configuration
########################
policy_file = /etc/moniker/policy.json
rabbit_hosts = <%= @rabbitmq_hosts.join(', ') %>
rabbit_password = <%= @rabbitmq_password %>
<%
node['moniker']['DEFAULT'].each do |key, value|
  next if ['policy_file', 'rabbit_hosts', 'rabbit_password'].include?(key)

  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

########################
## Service Configuration
########################
#-----------------------
# Central Service
#-----------------------
[service:central]
<%
node['moniker']['service:central'].each do |key, value|
  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

#-----------------------
# API Service
#-----------------------
[service:api]
<%
node['moniker']['service:api'].each do |key, value|
  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

#-----------------------
# Agent Service
#-----------------------
[service:agent]
<%
node['moniker']['service:agent'].each do |key, value|
  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

#-----------------------
# Sink Service
#-----------------------
[service:sink]
<%
node['moniker']['service:sink'].each do |key, value|
  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

########################
## Storage Configuration
########################
#-----------------------
# SQLAlchemy Storage
#-----------------------
[storage:sqlalchemy]
database_connection = <%= @sqlalchemy_database_connection %>
<%
node['moniker']['storage:sqlalchemy'].each do |key, value|
  next if key == 'database_connection'

  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

########################
## Handler Configuration
########################
#-----------------------
# Nova Fixed Handler
#-----------------------
[handler:nova_fixed]
<%
node['moniker']['handler:nova_fixed'].each do |key, value|
  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

#------------------------
# Quantum Floating Handler
#------------------------
[handler:quantum_floating]
<%
node['moniker']['handler:quantum_floating'].each do |key, value|
  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

########################
## Backend Configuration
########################
#-----------------------
# Bind9 Backend
#-----------------------
[backend:bind9]
<%
node['moniker']['backend:bind9'].each do |key, value|
  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>

#-----------------------
# PowerDNS Backend
#-----------------------
[backend:powerdns]
database_connection = <%= @powerdns_database_connection %>
<%
node['moniker']['backend:powerdns'].each do |key, value|
  next if key == 'database_connection'

  if value.nil? or (value.kind_of?(Array) and value.empty?)
    next
  elsif value.kind_of?(Array)
    _buf << "#{key} = #{value.join(', ')}\n"
  else
    _buf << "#{key} = #{value}\n"
  end
end
-%>